# Capitão Caverna Image Engine - API Documentation

## Overview

The Capitão Caverna Image Engine provides a RESTful API for generating images of the Capitão Caverna mascot using AI services. The API supports various poses, outfits, footwear, and props combinations to create consistent, high-quality images.

## Base URL

```
Production: https://capitao-caverna-image-engine-prod.workers.dev
```

## Authentication

All API endpoints require authentication using a JWT token in the Authorization header:

```http
Authorization: Bearer <jwt_token>
```

## Rate Limits

- **Per User**: 50 requests per hour
- **Per IP**: 100 requests per hour
- **Global**: 1000 requests per minute

Rate limit headers are included in responses:
- `X-RateLimit-Limit`: Request limit
- `X-RateLimit-Remaining`: Remaining requests
- `X-RateLimit-Reset`: Reset time (Unix timestamp)

## Content Safety

All prompts are automatically validated for content safety. Requests containing inappropriate content will be rejected with a 400 status code.

## API Endpoints

### Image Generation

#### Generate Image

Generate a new image based on specified parameters.

**Endpoint:** `POST /api/v1/images/generate`

**Request Body:**
```json
{
  "params": {
    "pose": "arms_crossed",
    "outfit": "hoodie_sweatpants", 
    "footwear": "air_jordan_1_chicago",
    "prop": "cave_map",
    "frameType": "standard",
    "frameId": "01A"
  }
}
```

**Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `pose` | string | Yes | Character pose (see [Available Poses](#available-poses)) |
| `outfit` | string | Yes | Character outfit (see [Available Outfits](#available-outfits)) |
| `footwear` | string | Yes | Character footwear (see [Available Footwear](#available-footwear)) |
| `prop` | string | No | Character prop (see [Available Props](#available-props)) |
| `frameType` | string | No | Frame type: `standard`, `onboarding`, `sequence` |
| `frameId` | string | No | Specific frame ID for sequences (e.g., "01A", "02B") |

**Response:**
```json
{
  "success": true,
  "data": {
    "imageId": "550e8400-e29b-41d4-a716-446655440000",
    "status": "PENDING",
    "estimatedTime": 30000,
    "queuePosition": 3
  }
}
```

**Status Codes:**
- `200` - Success
- `400` - Invalid parameters or content safety violation
- `401` - Unauthorized
- `429` - Rate limit exceeded
- `500` - Internal server error

#### Check Image Status

Check the status of an image generation request.

**Endpoint:** `GET /api/v1/images/{imageId}/status`

**Path Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `imageId` | string | Yes | UUID of the image generation request |

**Response:**
```json
{
  "success": true,
  "data": {
    "imageId": "550e8400-e29b-41d4-a716-446655440000",
    "status": "COMPLETE",
    "publicUrl": "https://capitao-caverna-images-prod.r2.dev/generated/image.png",
    "generationTime": 25000,
    "serviceUsed": "midjourney",
    "createdAt": "2025-01-30T12:00:00Z",
    "completedAt": "2025-01-30T12:00:25Z"
  }
}
```

**Status Values:**
- `PENDING` - Request is queued for processing
- `PROCESSING` - Image is being generated
- `COMPLETE` - Image generation completed successfully
- `FAILED` - Image generation failed

**Status Codes:**
- `200` - Success
- `404` - Image not found
- `401` - Unauthorized

### User Management

#### Get User Images

Retrieve images generated by a specific user.

**Endpoint:** `GET /api/v1/images/user/{userId}`

**Path Parameters:**

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `userId` | string | Yes | User ID |

**Query Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `limit` | integer | No | 20 | Number of images to return (max 100) |
| `offset` | integer | No | 0 | Pagination offset |
| `status` | string | No | all | Filter by status: `PENDING`, `COMPLETE`, `FAILED` |
| `sortBy` | string | No | created_at | Sort field: `created_at`, `status`, `generation_time` |
| `sortOrder` | string | No | desc | Sort order: `asc`, `desc` |

**Response:**
```json
{
  "success": true,
  "data": {
    "images": [
      {
        "imageId": "550e8400-e29b-41d4-a716-446655440000",
        "status": "COMPLETE",
        "publicUrl": "https://capitao-caverna-images-prod.r2.dev/generated/image1.png",
        "parameters": {
          "pose": "arms_crossed",
          "outfit": "hoodie_sweatpants",
          "footwear": "air_jordan_1_chicago"
        },
        "createdAt": "2025-01-30T12:00:00Z",
        "generationTime": 25000
      }
    ],
    "pagination": {
      "total": 150,
      "limit": 20,
      "offset": 0,
      "hasMore": true
    }
  }
}
```

### System Endpoints

#### Health Check

Check system health and component status.

**Endpoint:** `GET /health`

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-01-30T12:00:00Z",
  "checks": {
    "database": {
      "status": "pass",
      "responseTime": 45,
      "message": "Database is healthy"
    },
    "storage": {
      "status": "pass", 
      "responseTime": 120,
      "message": "Storage is healthy"
    },
    "externalServices": {
      "status": "pass",
      "message": "External services configuration is healthy"
    },
    "memory": {
      "status": "pass",
      "message": "Memory check completed"
    },
    "performance": {
      "status": "pass",
      "responseTime": 200,
      "message": "Performance is optimal"
    }
  },
  "metadata": {
    "version": "1.0.0",
    "environment": "production",
    "region": "global"
  }
}
```

**Status Values:**
- `healthy` - All systems operational
- `degraded` - Some systems experiencing issues
- `unhealthy` - Critical systems failing

#### System Metrics

Get system performance metrics.

**Endpoint:** `GET /metrics`

**Response:**
```json
{
  "timestamp": "2025-01-30T12:00:00Z",
  "metrics": {
    "requests": {
      "total": 1250,
      "successful": 1200,
      "failed": 50,
      "averageResponseTime": 850
    },
    "images": {
      "generated": 980,
      "cached": 45,
      "failed": 25,
      "averageGenerationTime": 28000
    },
    "storage": {
      "totalObjects": 5000,
      "totalSize": 2500000000,
      "uploadSuccess": 980,
      "uploadFailures": 5
    },
    "database": {
      "queries": 2500,
      "averageQueryTime": 45,
      "connections": 1,
      "errors": 2
    }
  }
}
```

### Admin Endpoints

Admin endpoints require admin role authentication.

#### Security Report

Generate comprehensive security report.

**Endpoint:** `GET /api/v1/admin/security/report`

**Headers:**
```http
Authorization: Bearer <admin_jwt_token>
```

**Response:**
```json
{
  "success": true,
  "data": {
    "summary": {
      "totalRequests": 1250,
      "blockedRequests": 15,
      "failedAuthentications": 8,
      "contentViolations": 3
    },
    "topRisks": [
      {
        "type": "rate_limit_exceeded",
        "count": 12,
        "description": "rate_limit_exceeded (medium risk): 12 incidents"
      }
    ],
    "recommendations": [
      "Consider reviewing rate limiting policies - high number of blocked requests"
    ]
  },
  "timestamp": "2025-01-30T12:00:00Z"
}
```

#### Security Audit Logs

Retrieve security audit logs.

**Endpoint:** `GET /api/v1/admin/security/audit`

**Query Parameters:**

| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `limit` | integer | No | 50 | Number of logs to return |
| `offset` | integer | No | 0 | Pagination offset |
| `risk_level` | string | No | all | Filter by risk level: `low`, `medium`, `high` |
| `action` | string | No | all | Filter by action type |
| `status` | string | No | all | Filter by status: `success`, `failure`, `blocked` |

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "id": "audit-123",
      "timestamp": "2025-01-30T12:00:00Z",
      "userId": "user-456",
      "ipAddress": "192.168.1.1",
      "userAgent": "Mozilla/5.0...",
      "action": "image_generation_request",
      "resource": "/api/v1/images/generate",
      "status": "success",
      "riskLevel": "low",
      "details": {
        "responseTime": 850
      }
    }
  ],
  "pagination": {
    "limit": 50,
    "offset": 0,
    "total": 1250
  }
}
```

## Available Options

### Available Poses

| Pose ID | Description |
|---------|-------------|
| `arms_crossed` | Arms crossed confidently |
| `pointing_forward` | Pointing forward gesture |
| `sitting_on_rock` | Sitting on cave rock |
| `holding_cave_map` | Holding cave exploration map |
| `thumbs_up` | Thumbs up gesture |
| `waving` | Friendly waving |
| `thinking` | Thoughtful pose |
| `celebrating` | Victory celebration |

### Available Outfits

| Outfit ID | Description |
|-----------|-------------|
| `hoodie_sweatpants` | Hoodie with sweatpants |
| `tshirt_shorts` | T-shirt with shorts |
| `windbreaker_shorts` | Windbreaker with shorts |

### Available Footwear

| Footwear ID | Description |
|-------------|-------------|
| `air_jordan_1_chicago` | Air Jordan 1 Chicago colorway |
| `air_jordan_11_bred` | Air Jordan 11 Bred colorway |
| `nike_dunk_low` | Nike Dunk Low |
| `adidas_ultraboost` | Adidas Ultraboost |
| `converse_chuck_taylor` | Converse Chuck Taylor All Star |

### Available Props

| Prop ID | Description |
|---------|-------------|
| `cave_map` | Cave exploration map |
| `glowing_hourglass` | Magical glowing hourglass |
| `stone_totem` | Ancient stone totem |
| `crystal_shard` | Glowing crystal shard |
| `torch` | Cave exploration torch |

## Error Handling

### Error Response Format

All error responses follow this format:

```json
{
  "success": false,
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": {
    "field": "Additional error details"
  },
  "timestamp": "2025-01-30T12:00:00Z"
}
```

### Common Error Codes

| Code | Status | Description |
|------|--------|-------------|
| `INVALID_PARAMETERS` | 400 | Request parameters are invalid |
| `CONTENT_SAFETY_VIOLATION` | 400 | Content violates safety guidelines |
| `UNAUTHORIZED` | 401 | Authentication required |
| `FORBIDDEN` | 403 | Insufficient permissions |
| `NOT_FOUND` | 404 | Resource not found |
| `RATE_LIMIT_EXCEEDED` | 429 | Rate limit exceeded |
| `INTERNAL_ERROR` | 500 | Internal server error |
| `SERVICE_UNAVAILABLE` | 503 | External service unavailable |

### Rate Limit Error

```json
{
  "success": false,
  "error": "Rate limit exceeded",
  "code": "RATE_LIMIT_EXCEEDED",
  "retryAfter": 3600,
  "details": {
    "limit": 50,
    "remaining": 0,
    "resetTime": 1706616000
  }
}
```

### Content Safety Error

```json
{
  "success": false,
  "error": "Content does not meet safety guidelines",
  "code": "CONTENT_SAFETY_VIOLATION",
  "details": [
    "blocked_keyword:violence",
    "suspicious_pattern"
  ]
}
```

## SDK Examples

### JavaScript/TypeScript

```typescript
class CapitaoCavernaAPI {
  constructor(private baseUrl: string, private token: string) {}

  async generateImage(params: ImageParams): Promise<ImageResponse> {
    const response = await fetch(`${this.baseUrl}/api/v1/images/generate`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ params })
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    return response.json();
  }

  async checkStatus(imageId: string): Promise<ImageStatus> {
    const response = await fetch(`${this.baseUrl}/api/v1/images/${imageId}/status`, {
      headers: {
        'Authorization': `Bearer ${this.token}`
      }
    });

    return response.json();
  }
}

// Usage
const api = new CapitaoCavernaAPI('https://your-worker.workers.dev', 'your-token');

const result = await api.generateImage({
  pose: 'arms_crossed',
  outfit: 'hoodie_sweatpants',
  footwear: 'air_jordan_1_chicago'
});

console.log('Image ID:', result.data.imageId);
```

### Python

```python
import requests
import time

class CapitaoCavernaAPI:
    def __init__(self, base_url: str, token: str):
        self.base_url = base_url
        self.headers = {
            'Authorization': f'Bearer {token}',
            'Content-Type': 'application/json'
        }
    
    def generate_image(self, params: dict) -> dict:
        response = requests.post(
            f'{self.base_url}/api/v1/images/generate',
            json={'params': params},
            headers=self.headers
        )
        response.raise_for_status()
        return response.json()
    
    def check_status(self, image_id: str) -> dict:
        response = requests.get(
            f'{self.base_url}/api/v1/images/{image_id}/status',
            headers=self.headers
        )
        response.raise_for_status()
        return response.json()
    
    def wait_for_completion(self, image_id: str, timeout: int = 300) -> dict:
        start_time = time.time()
        while time.time() - start_time < timeout:
            status = self.check_status(image_id)
            if status['data']['status'] in ['COMPLETE', 'FAILED']:
                return status
            time.sleep(5)
        raise TimeoutError('Image generation timed out')

# Usage
api = CapitaoCavernaAPI('https://your-worker.workers.dev', 'your-token')

result = api.generate_image({
    'pose': 'arms_crossed',
    'outfit': 'hoodie_sweatpants',
    'footwear': 'air_jordan_1_chicago'
})

image_id = result['data']['imageId']
final_result = api.wait_for_completion(image_id)

if final_result['data']['status'] == 'COMPLETE':
    print(f"Image URL: {final_result['data']['publicUrl']}")
```

## Webhooks (Future Feature)

Webhook support for real-time notifications is planned for future releases.

## Changelog

### Version 1.0.0 (2025-01-30)
- Initial API release
- Image generation with pose, outfit, footwear combinations
- Content safety validation
- Rate limiting and security features
- Health check and metrics endpoints
- Admin security dashboard

---

**API Version**: 1.0.0  
**Last Updated**: January 30, 2025  
**Support**: [Contact Information]